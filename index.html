<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary SEO Meta Tags - UPDATED -->
    <title>Coast FI Roadmap Calculator | Inflation-Adjusted Financial Freedom</title>
    <meta name="description" content="Calculate your exact Coast FI principal in today's dollars. Generate a step-by-step, inflation-adjusted roadmap showing your sprint and coast phases to financial independence.">
    <link rel="canonical" href="[REPLACE WITH YOUR LIVE GITHUB PAGES URL]"> 

    <!-- Open Graph / Social Media Tags (Used by Facebook, LinkedIn, etc.) - UPDATED -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="[REPLACE WITH YOUR LIVE GITHUB PAGES URL]">
    <meta property="og:title" content="Coast FI Roadmap Calculator | Inflation-Adjusted Financial Freedom">
    <meta property="og:description" content="Calculate your exact Coast FI principal in today's dollars. Generate a step-by-step, inflation-adjusted roadmap showing your sprint and coast phases to financial independence.">

    <!-- Twitter Card Tags (Used by X/Twitter) - UPDATED -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="[REPLACE WITH YOUR LIVE GITHUB PAGES URL]">
    <meta property="twitter:title" content="Coast FI Roadmap Calculator | Inflation-Adjusted Financial Freedom">
    <meta property="twitter:description" content="Calculate your exact Coast FI principal in today's dollars. Generate a step-by-step, inflation-adjusted roadmap showing your sprint and coast phases to financial independence.">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and mobile optimization */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Hide number input spinners for cleaner look */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .coast-phase-row {
            background-color: #ecfdf5; /* Tailwind Emerald 50 - Light Green */
            color: #065f46; /* Tailwind Emerald 800 */
        }
        .sprint-end-row {
            background-color: #fef3c7; /* Tailwind Amber 100 - Light Yellow */
            font-weight: bold;
            border-left: 4px solid #f59e0b; /* Tailwind Amber 500 */
        }
        /* Growth Exceeds Contributions Crossover Point */
        .growth-cross-row {
            background-color: #ffedd5; /* Amber 50 */
            border-left: 4px solid #f97316; /* Orange 500 */
            font-weight: 600;
        }
        /* Million Dollar Milestone */
        .million-dollar-row {
            background-color: #e0f2f1; /* Teal 50 */
            border-bottom: 2px solid #0d9488; /* Teal 600 */
            font-weight: 600;
        }
        .final-row {
            background-color: #d1fae5; /* Tailwind Emerald 100 */
            border-top: 2px solid #10b981;
            font-weight: bold;
        }
        .table-container {
            /* Adjusted max-height to handle the wider table on mobile */
            max-height: 500px; 
            overflow-y: auto;
        }
        .projection-table-wrapper {
             /* Allows horizontal scrolling on small screens */
            overflow-x: auto;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Emerald 500 (Success) */
                        'secondary': '#374151', /* Gray 700 (Text) */
                        'accent-blue': '#2563eb', /* Blue 600 */
                    },
                }
            }
        }
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6682497751539211"
     crossorigin="anonymous"></script>

</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center justify-start">

    <div id="app" class="w-full max-w-4xl">
        <div class="container-card bg-white p-6 sm:p-8 rounded-xl">
            <h1 class="text-3xl font-bold text-secondary mb-2 text-center">Inflation-Adjusted Coast FI Roadmap</h1>
            <p class="text-sm text-gray-500 mb-6 text-center" id="valueContext">All projected values are shown in **today's purchasing power (Real)**.</p>

            <!-- INSTRUCTIONS -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-700">
                <h3 class="font-bold text-lg text-secondary mb-2 text-center">How to Use This Calculator</h3>
                <ol class="list-decimal list-inside space-y-2">
                    <li><strong>Enter Your Financials:</strong> Fill in your current age, desired retirement age, current investment balances (split between Traditional and Roth accounts), and your expected annual return & inflation rates.</li>
                    <li><strong>Set Your Goal:</strong> Input your desired annual retirement income (in today's dollars) and how much you currently contribute annually to your Traditional and Roth accounts.</li>
                    <li><strong>Analyze Your Roadmap:</strong> The tool will instantly calculate your <span class="font-bold text-accent-blue">Coast FI Principal</span>—the amount you need today to coast to retirement. It also generates a year-by-year projection.</li>
                    <li><strong>Toggle Views:</strong> Use the "Show Real/Nominal Values" buttons to switch between today's purchasing power and future (inflated) dollars.</li>
                </ol>
            </div>

            <form id="coastFiForm" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                
                <!-- ROW 1: Ages, Balances, Rates -->
                
                <!-- Current Age Input -->
                <div>
                    <label for="currentAge" class="block text-sm font-medium text-gray-700">Current Age</label>
                    <input type="number" id="currentAge" value="30" min="1" max="90" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- Retirement Age Input -->
                <div>
                    <label for="retirementAge" class="block text-sm font-medium text-gray-700">Retirement Age</label>
                    <input type="number" id="retirementAge" value="65" min="40" max="90" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- Traditional Portfolio Balance -->
                <div>
                    <label for="traditionalBalance" class="block text-sm font-medium text-gray-700">Traditional Balance ($)</label>
                    <input type="number" id="traditionalBalance" value="70000" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- Roth Portfolio Balance -->
                <div>
                    <label for="rothBalance" class="block text-sm font-medium text-gray-700">Roth Balance ($)</label>
                    <input type="number" id="rothBalance" value="30000" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- Expected Annual Return (Nominal) -->
                <div>
                    <label for="annualReturn" class="block text-sm font-medium text-gray-700">Nominal Return (%)</label>
                    <input type="number" id="annualReturn" value="10" step="0.1" min="1" max="15" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- Annual Inflation Rate -->
                <div>
                    <label for="inflationRate" class="block text-sm font-medium text-gray-700">Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" value="3" step="0.1" min="0" max="10" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>

                <!-- ROW 2: Income and Contributions -->
                
                <!-- Desired Annual Retirement Income -->
                <div class="col-span-2 sm:col-span-2 md:col-span-2">
                    <label for="annualIncome" class="block text-sm font-medium text-gray-700">Desired Annual Retirement Income ($)</label>
                    <input type="number" id="annualIncome" value="80000" min="1000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                </div>
                
                <!-- Traditional Annual Contribution (Label Updated) -->
                <div class="col-span-2 sm:col-span-2 md:col-span-2">
                    <label for="traditionalContributions" class="block text-sm font-medium text-gray-700">Traditional Annual Contr. ($)</label>
                    <input type="text" inputmode="decimal" id="traditionalContributions" value="9000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                    <p class="mt-1 text-xs text-gray-500/80">Inline math functions are supported (e.g., 1000*12).</p>
                </div>
                
                <!-- Roth Annual Contribution (Label Updated) -->
                <div class="col-span-2 sm:col-span-2 md:col-span-2">
                    <label for="rothContributions" class="block text-sm font-medium text-gray-700">Roth Annual Contr. ($)</label>
                    <input type="text" inputmode="decimal" id="rothContributions" value="3000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-primary focus:ring-primary transition" required>
                    <!-- IRS Limit Reminder -->
                    <p class="mt-1 text-xs text-red-500/80">Remember annual contributions must comply with IRS limits.</p>
                    <p class="mt-1 text-xs text-gray-500/80">Inline math functions are supported (e.g., 1000*12).</p>
                </div>
            </form>

            <div id="results" class="mt-8 p-4 rounded-xl border border-gray-200 bg-gray-50">
                
                <!-- Display Mode Toggle -->
                <div class="flex justify-center mb-4">
                    <button id="realModeBtn" class="px-4 py-2 text-xs sm:text-sm font-semibold rounded-l-lg bg-primary text-white transition hover:bg-emerald-600 focus:outline-none">
                        Show Real Values (Today's $)
                    </button>
                    <button id="nominalModeBtn" class="px-4 py-2 text-xs sm:text-sm font-semibold rounded-r-lg bg-gray-300 text-gray-700 transition hover:bg-gray-400 focus:outline-none">
                        Show Nominal Values (Future $)
                    </button>
                </div>

                <h2 class="text-xl font-semibold text-secondary mb-3 text-center">Key Milestones</h2>
                <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-600">
                    <!-- UPDATED: Removed ($F$, 25x Income) -->
                    <p>FI Target: <span id="targetFI" class="font-bold text-secondary">$0</span></p>
                    <p id="rateDisplay">Real Rate of Return: <span id="realRate" class="font-bold text-secondary">0%</span></p>
                    
                    <!-- UPDATED: Removed ($n$) -->
                    <p>Years until Retirement: <span id="yearsToRetirement" class="font-bold text-secondary">0</span></p>
                    
                    <!-- Coast Principal required today (P_coast calculated for the current age) -->
                    <p class="text-base font-semibold text-accent-blue mt-3 col-span-2">Coast Principal Required TODAY: <span id="requiredCoastPrincipalEl" class="font-extrabold">$0</span></p>
                    
                    <!-- Years to Coast -->
                    <p class="text-base font-semibold text-primary">Years to Reach Coast FI: <span id="yearsToCoastEl" class="font-extrabold text-secondary">N/A</span></p>

                    <!-- Value at Coast Date -->
                    <p class="text-sm">Required Value at Coast Date: <span id="valueAtCoast" class="font-bold text-secondary">$0</span></p>
                    
                    <!-- Total Contributions at Coast -->
                    <p class="text-sm border-t border-gray-200 pt-2 mt-2 col-span-2">Total Contributions at Coast Date: <span id="totalContributionsEl" class="font-bold text-primary">$0</span></p>

                    <!-- NEW: Coast Balances -->
                    <p class="text-sm border-t border-gray-200 pt-2 mt-2 col-span-2 font-bold text-gray-700">Account Balances at Coast FI Age (<span id="coastAgeDisplay">N/A</span>)</p>
                    <p class="text-sm">Traditional Coast Bal.: <span id="traditionalCoastBalance" class="font-bold text-secondary">$0</span></p>
                    <p class="text-sm">Roth Coast Bal.: <span id="rothCoastBalance" class="font-bold text-secondary">$0</span></p>

                    <!-- NEW: Retirement Balances -->
                    <p class="text-sm border-t border-gray-200 pt-2 mt-2 col-span-2 font-bold text-gray-700">Projected Account Balances at Retirement (Age <span id="retirementAgeDisplay">65</span>)</p>
                    <p class="text-sm">Traditional Final Bal.: <span id="traditionalFinalBalance" class="font-bold text-secondary">$0</span></p>
                    <p class="text-sm">Roth Final Bal.: <span id="rothFinalBalance" class="font-bold text-secondary">$0</span></p>

                    <!-- Final Value at Retirement (Summary) -->
                    <p class="text-base font-semibold text-secondary col-span-2 border-t border-gray-200 pt-2 mt-2">Projected Final Value (Total): <span id="projectedFinalValue" class="font-extrabold">$0</span></p>
                </div>

                <div id="verdict" class="mt-4 p-4 rounded-lg text-white font-bold text-lg text-center transition-all duration-300">
                    Awaiting Input...
                </div>
            </div>
            
            <!-- NEW: RECOMMENDED ACTIONS SECTION (VISIBLE ON FAILURE) -->
            <div id="recommendedActions" class="mt-8 p-6 bg-red-50 border border-red-400 rounded-xl hidden">
                <h3 class="text-xl font-bold text-red-700 mb-4 text-center">Course Correction: Actions to Hit Your FI Target</h3>
                <p class="text-red-700 mb-3 text-sm" id="shortfallMessage">Your projected final value is **$0** short of your required FI Target of **$0** (in today's dollars).</p>
                <div class="space-y-4">
                    <div id="action1" class="p-3 bg-white rounded-lg border border-red-200 shadow-sm text-sm"></div>
                    <div id="action2" class="p-3 bg-white rounded-lg border border-red-200 shadow-sm text-sm"></div>
                    <div id="action3" class="p-3 bg-white rounded-lg border border-red-200 shadow-sm text-sm">
                        <p class="font-bold text-gray-800">Option 3: Lower the Target</p>
                        <p class="mt-1 text-gray-700">Reduce your Desired Annual Retirement Income to align with your current projection. Consider aiming for **Lean FI** or **Barista FI** instead of traditional FI.</p>
                    </div>
                </div>
            </div>
            <!-- END RECOMMENDED ACTIONS SECTION -->
            
            <!-- AFFILIATE CTA BOX (New Addition for Monetization) -->
            <div class="mt-8 p-6 bg-blue-50 border border-accent-blue rounded-xl text-center">
                <h3 class="text-xl font-bold text-accent-blue mb-2">Ready to Start Coasting?</h3>
                <p class="text-gray-700 mb-4 text-sm">Invest your **Coast FI principal** in a reliable, low-cost platform.</p>
                <a href="https://join.robinhood.com/benjamc12" target="_blank" class="inline-block bg-accent-blue text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    Open an Account with Robinhood &rarr;
                </a>
                <p class="mt-2 text-xs text-gray-500">Affiliate Link: This site may earn a commission if you sign up.</p>
            </div>
            
            <!-- CONTRIBUTION SUGGESTIONS (NEW SECTION) -->
            <div id="contributionSuggestions" class="mt-8 p-6 bg-green-50 border border-primary rounded-xl hidden">
                <h3 class="text-xl font-bold text-primary mb-3 text-center">How to Coast FI Faster</h3>
                <div id="suggestion1" class="mb-3 p-3 bg-white rounded-lg border border-green-200 shadow-sm text-sm"></div>
                <div id="suggestion2" class="p-3 bg-white rounded-lg border border-green-200 shadow-sm text-sm"></div>
            </div>

            <!-- Projection Table Container -->
            <div id="projectionTableContainer" class="mt-8">
                <!-- Dynamic projection table will be inserted here -->
            </div>

            <!-- FIX: Added visibility on failure -->
            <div id="errorMessage" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm" role="alert">
                Please ensure all fields are filled with valid numbers (no blank inputs), and that your Retirement Age is greater than or equal to your Current Age.
            </div>

            <!-- NEW: Explanation Section -->
            <div id="coastFiExplanation" class="mt-12 p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-secondary mb-4 text-center border-b pb-2">Understanding Coast Financial Independence (Coast FI)</h2>
                
                <p class="text-gray-700 mb-4">
                    **Coast FI** is a powerful financial milestone where your current investment portfolio is large enough that, without adding any more money, it will naturally grow through compounding to reach your full Financial Independence (FI) number by your chosen traditional retirement age. Essentially, you've finished the intense saving "sprint" and can now "coast" to the finish line.
                </p>

                <h3 class="text-xl font-semibold text-primary mb-3">The Core Benefits of Reaching Coast FI:</h3>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-start">
                        <span class="text-primary text-xl font-bold mr-3">&#10003;</span>
                        <div>
                            <span class="font-semibold">Career Flexibility:</span> This is the biggest advantage. You are no longer financially obligated to maintain a high-stress or high-paying job. You can pursue part-time work, change careers to a passion project, or take a significant pay cut knowing your retirement is secured.
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-primary text-xl font-bold mr-3">&#10003;</span>
                        <div>
                            <span class="font-semibold">Reduced Stress & Burnout:</span> The immense pressure to save is gone. You only need to earn enough to cover your current living expenses, allowing you to downshift and focus on your quality of life today.
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-primary text-xl font-bold mr-3">&#10003;</span>
                        <div>
                            <span class="font-semibold">Maximize Compounding:</span> By achieving the required principal early, you maximize the time your money spends growing tax-advantaged (like in your 401k/IRA), letting exponential growth do the heavy lifting for the final push.
                        </div>
                    </li>
                </ul>
                <p class="mt-4 text-sm text-gray-500 italic">
                    Note: Your **Coast FI Principal Required TODAY** is dynamic; it <span class="font-bold text-red-500">increases</span> every year as you get older, because your money has fewer years left to compound passively until retirement. (This means the required number you need *to hit* gets harder to reach the longer you wait!)
                </p>
            </div>
        </div>
    </div>
    
    <!-- NEW DISCLAIMER SECTION -->
    <div class="w-full max-w-4xl mt-6 p-4 text-center text-xs text-gray-500 rounded-lg bg-white/50 border border-gray-100">
        <p class="font-bold mb-1">Disclaimer</p>
        <p>These calculations are based entirely on user-provided inputs (e.g., estimated returns, inflation rates) and are for **visualization and planning purposes only**. This roadmap does not constitute financial advice, and actual investment results are not guaranteed. Past performance is not indicative of future results.</p>
    </div>
    <!-- END NEW DISCLAIMER SECTION -->

    <script>
        // --- DOM Elements ---
        const form = document.getElementById('coastFiForm');
        const targetFIEl = document.getElementById('targetFI');
        const yearsToRetirementEl = document.getElementById('yearsToRetirement');
        const requiredCoastPrincipalEl = document.getElementById('requiredCoastPrincipalEl');
        const yearsToCoastEl = document.getElementById('yearsToCoastEl');
        const valueAtCoast = document.getElementById('valueAtCoast');
        const totalContributionsEl = document.getElementById('totalContributionsEl'); 
        const projectedFinalValueEl = document.getElementById('projectedFinalValue');
        const verdictEl = document.getElementById('verdict');
        const errorEl = document.getElementById('errorMessage');
        const projectionContainer = document.getElementById('projectionTableContainer');
        const realRateEl = document.getElementById('realRate');
        const rateDisplayEl = document.getElementById('rateDisplay'); 
        const realModeBtn = document.getElementById('realModeBtn');
        const nominalModeBtn = document.getElementById('nominalModeBtn');
        const valueContextEl = document.getElementById('valueContext');
        const suggestionsContainer = document.getElementById('contributionSuggestions');
        const suggestion1El = document.getElementById('suggestion1');
        const suggestion2El = document.getElementById('suggestion2');
        const coastAgeDisplayEl = document.getElementById('coastAgeDisplay');
        const traditionalCoastBalanceEl = document.getElementById('traditionalCoastBalance');
        const rothCoastBalanceEl = document.getElementById('rothCoastBalance');
        const traditionalFinalBalanceEl = document.getElementById('traditionalFinalBalance');
        const rothFinalBalanceEl = document.getElementById('rothFinalBalance');
        const retirementAgeDisplayEl = document.getElementById('retirementAgeDisplay');
        
        // NEW: Action elements
        const recommendedActionsEl = document.getElementById('recommendedActions');
        const action1El = document.getElementById('action1');
        const action2El = document.getElementById('action2');
        const shortfallMessageEl = document.getElementById('shortfallMessage'); // Added element for easy update


        // --- Global State ---
        let projectionData = [];
        let displayMode = 'real'; // 'real' or 'nominal'
        let fiTargetReal = 0;
        let requiredCoastPrincipalTodayReal = 0;
        let finalCoastValueReal = 0; // The actual required Coast FI number at the time of coasting
        let totalContributionsAtCoastRealGlobal = 0; 
        let totalContributionsNominalGlobal = 0; 
        let projectedFinalValueReal = 0;
        let yearsToCoastGlobal = 'N/A';
        let yearsToCoastNumberGlobal = Infinity;
        let coastAgeGlobal = 0;
        let retirementAgeGlobal = 0;
        let ageGlobal = 0;
        let isCoastReachedGlobal = false;
        let inflationRateGlobal = 0;
        let initialBalanceGlobal = 0; 
        let realRateGlobal = 0;
        
        // Balances for specific accounts at milestones
        let traditionalCoastBalanceRealGlobal = 0;
        let rothCoastBalanceRealGlobal = 0;
        let traditionalFinalBalanceRealGlobal = 0;
        let rothFinalBalanceRealGlobal = 0;
        
        // NEW: Global storage for suggested action values
        let suggestedAdditionalContributionReal = 0;
        let suggestedNewRetirementAge = 0;


        /**
         * Formats a number into a currency string (e.g., $1,234,567)
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        /**
         * Calculates the required Coast FI Principal for a given remaining time.
         * P_coast = F / (1 + r_real)^n
         * @param {number} fiTarget - The final FI number (25x income) in real dollars.
         * @param {number} realRate - The real (inflation-adjusted) annual return rate (as a decimal).
         * @param {number} remainingYears - The number of years left until retirement.
         * @returns {number} The required Coast Principal in real dollars.
         */
        function calculateRequiredPrincipal(fiTarget, realRate, remainingYears) {
             if (remainingYears <= 0) return fiTarget;
             // Ensure we don't calculate future value using negative years
             const years = Math.max(0, remainingYears);
             return fiTarget / Math.pow(1 + realRate, years);
        }

        /**
         * Converts a real (today's) dollar amount to its nominal (future) dollar amount.
         * Nominal = Real * (1 + inflation_rate)^years
         * @param {number} realAmount
         * @param {number} years
         * @param {number} inflationRate
         * @returns {number} The nominal amount.
         */
        function convertToNominal(realAmount, years, inflationRate) {
            // If years is 0, factor is 1, returns realAmount.
            if (years <= 0) return realAmount; 
            return realAmount * Math.pow(1 + inflationRate, years);
        }

        /**
         * Simulates the sprint phase to find the years required to reach Coast FI. (Used for suggestions)
         * @param {number} initialBalance - Starting balance (Total Real).
         * @param {number} initialAge - Starting age.
         * @param {number} retirementAge - Target retirement age.
         * @param {number} realRate - Real rate of return (decimal).
         * @param {number} fiTargetReal - FI Target (Real).
         * @param {number} annualContributionReal - Annual contribution during sprint (Total Real).
         * @returns {{years: number, balance: number, contributions: number}} years to reach coast, final coast balance, and total real contributions.
         */
        function simulateToCoast(initialBalance, initialAge, retirementAge, realRate, fiTargetReal, annualContributionReal) {
            let currentBalanceReal = initialBalance;
            let currentAge = initialAge;
            let year = 0;
            let totalContributions = 0; 
            
            const yearsToRetirementToday = retirementAge - initialAge;
            const requiredPrincipalToday = calculateRequiredPrincipal(fiTargetReal, realRate, yearsToRetirementToday);
            
            if (initialBalance >= requiredPrincipalToday) {
                return { years: 0, balance: initialBalance, contributions: 0 };
            }

            // Iterative simulation
            while (currentAge < retirementAge) {
                const remainingYears = retirementAge - (currentAge + 1); 
                let requiredCoastPrincipalThisYearReal = calculateRequiredPrincipal(fiTargetReal, realRate, remainingYears); 
                
                // Balance grows
                const balanceAfterGrowthReal = currentBalanceReal * (1 + realRate);
                const endBalanceReal = balanceAfterGrowthReal + annualContributionReal;
                totalContributions += annualContributionReal; 

                // FIX: Added a check for floating point equality using a small epsilon (0.0001) for the coast check.
                if (endBalanceReal >= requiredCoastPrincipalThisYearReal - 0.0001) {
                    // Coast reached! The required principal is the goal we met.
                    return { years: year + 1, balance: requiredCoastPrincipalThisYearReal, contributions: totalContributions };
                }

                currentBalanceReal = endBalanceReal; 
                currentAge++;
                year++;
            }

            // Coast not reached
            return { years: Infinity, balance: currentBalanceReal, contributions: totalContributions };
        }


        /**
         * Generates the full projection data array (Sprint and Coast) and tracks T/R splits.
         */
        function calculateCoastFI() {
            // Always hide error message at start of successful run attempt
            errorEl.classList.add('hidden');
            projectionContainer.innerHTML = ''; 
            
            // --- Input Collection (Default to 0 if blank/invalid) ---
            const age = parseFloat(document.getElementById('currentAge').value) || 0;
            const retirementAge = parseFloat(document.getElementById('retirementAge').value) || 0;
            const nominalRateInput = parseFloat(document.getElementById('annualReturn').value) || 0;
            const inflationRateInput = parseFloat(document.getElementById('inflationRate').value) || 0;
            const income = parseFloat(document.getElementById('annualIncome').value) || 0;
            
            // Split Balances and Contributions
            const traditionalBalance = parseFloat(document.getElementById('traditionalBalance').value) || 0;
            const rothBalance = parseFloat(document.getElementById('rothBalance').value) || 0;
            const traditionalContributions = parseFloat(document.getElementById('traditionalContributions').value) || 0;
            const rothContributions = parseFloat(document.getElementById('rothContributions').value) || 0;

            // Apply division for rates (handle division by 100 safely)
            const nominalRate = nominalRateInput / 100;
            const inflationRate = inflationRateInput / 100;

            // Aggregate Totals
            const totalBalance = traditionalBalance + rothBalance;
            const totalInitialContributions = traditionalContributions + rothContributions;


            // Validation check: Ages must be positive, retirement age must be after current age, and income must be set.
            if (age < 1 || retirementAge < age || income <= 0) {
                
                // --- Handle invalid state by showing error and resetting key metrics ---
                errorEl.classList.remove('hidden');
                
                fiTargetReal = 0;
                requiredCoastPrincipalTodayReal = 0;
                finalCoastValueReal = 0;
                projectedFinalValueReal = 0;
                totalContributionsAtCoastRealGlobal = 0; 
                totalContributionsNominalGlobal = 0; 
                yearsToCoastGlobal = 'N/A';
                yearsToCoastNumberGlobal = Infinity;
                isCoastReachedGlobal = false;
                traditionalCoastBalanceRealGlobal = 0;
                rothCoastBalanceRealGlobal = 0;
                traditionalFinalBalanceRealGlobal = 0;
                rothFinalBalanceRealGlobal = 0;

                // Ensure verdict shows 'Awaiting Input...'
                verdictEl.className = 'mt-4 p-4 rounded-lg text-white font-bold text-lg text-center bg-gray-400 transition-all duration-300';
                verdictEl.innerHTML = `Awaiting Input...`;
                
                updateDisplay(true); // Force update to reset visuals
                return;
            }

            // --- Setup Global Variables for Display & Calculation ---
            inflationRateGlobal = inflationRate;
            ageGlobal = age;
            retirementAgeGlobal = retirementAge;
            initialBalanceGlobal = totalBalance; 
            
            // Calculate Real Rate: (1 + r_nominal) / (1 + i) - 1
            realRateGlobal = (1 + nominalRate) / (1 + inflationRate) - 1; 
            
            fiTargetReal = income * 25;
            const yearsToRetirement = Math.max(0, retirementAge - age);
            
            requiredCoastPrincipalTodayReal = calculateRequiredPrincipal(fiTargetReal, realRateGlobal, yearsToRetirement);

            // --- Simulation Logic Setup ---
            projectionData = [];
            let yearsToCoastLocal = 0;
            let finalCoastValueLocal = 0; // The REQUIRED principal at the coast age
            let coastAgeLocal = 0;
            
            let currentTraditionalBalanceReal = traditionalBalance;
            let currentRothBalanceReal = rothBalance;
            
            let currentAge = age; 
            let totalContributionsReal = 0; 
            let totalContributionsNominal = 0; 

            // NEW: Milestone Trackers
            let firstGrowthExceedsContributionYear = null;
            let firstMillionDollarYear = null;
            
            // Initial check: Did they already hit Coast FI?
            // FIX: Added a check for floating point equality using a small epsilon (0.0001)
            let isCoastReachedLocal = (totalBalance >= requiredCoastPrincipalTodayReal - 0.0001); 
            let isSprinting = !isCoastReachedLocal;

            if (isCoastReachedLocal) {
                // Already coasted - set initial results
                coastAgeLocal = age;
                finalCoastValueLocal = requiredCoastPrincipalTodayReal; // Use required for metric consistency
                yearsToCoastLocal = 0; 
                
                // Initial balances are the coast balances
                traditionalCoastBalanceRealGlobal = traditionalBalance;
                rothCoastBalanceRealGlobal = rothBalance;
                totalContributionsAtCoastRealGlobal = 0; 
                totalContributionsNominalGlobal = 0; 
            }

            // --- Iterative calculation loop from current age to retirement age ---
            let year = 0;
            while (currentAge < retirementAge) {
                year++; // Year number (1-indexed)
                
                // Use the T/R balances from the end of the previous year
                const startingTraditionalBalanceReal = currentTraditionalBalanceReal;
                const startingRothBalanceReal = currentRothBalanceReal;
                const startingBalanceReal = startingTraditionalBalanceReal + startingRothBalanceReal;
                
                // Years left to compound *after* this year ends
                const remainingYears = retirementAge - (currentAge + 1); 
                
                // Dynamic Target: The amount needed *at the end of this year* (REAL)
                let requiredCoastPrincipalThisYearReal = calculateRequiredPrincipal(fiTargetReal, realRateGlobal, remainingYears); 
                
                // 1. Growth 
                const traditionalGrowthReal = startingTraditionalBalanceReal * realRateGlobal; 
                const rothGrowthReal = startingRothBalanceReal * realRateGlobal;
                const growthReal = traditionalGrowthReal + rothGrowthReal;
                
                const balanceTraditionalAfterGrowthReal = startingTraditionalBalanceReal + traditionalGrowthReal;
                const balanceRothAfterGrowthReal = startingRothBalanceReal + rothGrowthReal;
                
                let endTraditionalBalanceReal = 0;
                let endRothBalanceReal = 0;
                let endBalanceReal = 0;
                let rowClass = '';
                let coastTag = '';

                let actualContributionRealTotal = 0; // The real contribution amount for this specific year

                // --- Sprint Logic (Active Contributions in Real Dollars) ---
                if (isSprinting) {
                    let actualTraditionalContributionReal = traditionalContributions;
                    let actualRothContributionReal = rothContributions;
                    actualContributionRealTotal = actualTraditionalContributionReal + actualRothContributionReal;

                    const balanceAfterGrowthReal = balanceTraditionalAfterGrowthReal + balanceRothAfterGrowthReal;
                    
                    // Check if Coast FI is reached this year
                    // FIX: Added a check for floating point equality using a small epsilon (0.0001)
                    if (balanceAfterGrowthReal + actualContributionRealTotal >= requiredCoastPrincipalThisYearReal - 0.0001 && !isCoastReachedLocal) {
                        isSprinting = false; // Stop contributions next year
                        isCoastReachedLocal = true; // Mark as reached
                        
                        // Reduce final year's contribution to hit the number exactly
                        const neededContribution = requiredCoastPrincipalThisYearReal - balanceAfterGrowthReal;
                        actualContributionRealTotal = Math.max(0, neededContribution);

                        const totalInitialContributionsForRatio = traditionalContributions + rothContributions;
                        if (totalInitialContributionsForRatio > 0) {
                            const traditionalRatio = traditionalContributions / totalInitialContributionsForRatio;
                            actualTraditionalContributionReal = actualContributionRealTotal * traditionalRatio;
                            actualRothContributionReal = actualContributionRealTotal * (1 - traditionalRatio);
                        } else {
                            // If no contributions were planned, but some are needed, put it all in traditional
                            actualTraditionalContributionReal = actualContributionRealTotal;
                            actualRothContributionReal = 0;
                        }
                        
                        // Record the milestone values (the required value)
                        finalCoastValueLocal = requiredCoastPrincipalThisYearReal;
                        yearsToCoastLocal = year;
                        coastAgeLocal = currentAge + 1;
                        
                        const calculatedEndTraditionalBalanceReal = balanceTraditionalAfterGrowthReal + actualTraditionalContributionReal;
                        const calculatedEndRothBalanceReal = balanceRothAfterGrowthReal + actualRothContributionReal;
                        const totalCalculatedEnd = calculatedEndTraditionalBalanceReal + calculatedEndRothBalanceReal;

                        // Record Account-specific Coast Balances (proportional split of the REQUIRED principal)
                        const proportion = totalCalculatedEnd > 0 ? calculatedEndTraditionalBalanceReal / totalCalculatedEnd : 0;
                        traditionalCoastBalanceRealGlobal = requiredCoastPrincipalThisYearReal * proportion;
                        rothCoastBalanceRealGlobal = requiredCoastPrincipalThisYearReal * (1 - proportion);
                        
                        rowClass = 'sprint-end-row';
                        coastTag = '🚀 COAST FI!';
                        
                        // Update Balances for next iteration
                        endTraditionalBalanceReal = calculatedEndTraditionalBalanceReal;
                        endRothBalanceReal = calculatedEndRothBalanceReal;
                        endBalanceReal = totalCalculatedEnd;

                    } else {
                         // Update Balances for next iteration (MUST use the FULL calculated amount)
                        endTraditionalBalanceReal = balanceTraditionalAfterGrowthReal + actualTraditionalContributionReal;
                        endRothBalanceReal = balanceRothAfterGrowthReal + actualRothContributionReal;
                        endBalanceReal = endTraditionalBalanceReal + endRothBalanceReal;
                    }
                    
                    if (isSprinting) {
                        rowClass = 'hover:bg-gray-50'; 
                    }

                } else {
                    // --- Coast Logic (Passive Compounding) ---
                    endTraditionalBalanceReal = balanceTraditionalAfterGrowthReal;
                    endRothBalanceReal = balanceRothAfterGrowthReal;
                    endBalanceReal = endTraditionalBalanceReal + endRothBalanceReal;
                    
                    rowClass = 'coast-phase-row';
                }

                // Always accumulate contributions while sprinting (or if coast was reached this year)
                if (isCoastReachedLocal && year <= yearsToCoastLocal && yearsToCoastLocal !== 0) {
                    // This is for the total contributions stat display
                    totalContributionsReal += actualContributionRealTotal; 
                    totalContributionsNominal += convertToNominal(actualContributionRealTotal, year, inflationRate); 
                } else if (!isCoastReachedLocal) {
                    // If still sprinting and not coasted this year
                    totalContributionsReal += actualContributionRealTotal; 
                    totalContributionsNominal += convertToNominal(actualContributionRealTotal, year, inflationRate); 
                }


                // Update T/R balances for the start of the *next* year
                currentTraditionalBalanceReal = endTraditionalBalanceReal;
                currentRothBalanceReal = endRothBalanceReal;

                // --- NEW: Milestone Checkers ---
                const currentYearAge = currentAge + 1;
                
                // 1. Growth Exceeds Contributions Milestone (Only while sprinting)
                const contributionRealForCheck = traditionalContributions + rothContributions;
                if (isSprinting && !firstGrowthExceedsContributionYear && growthReal > contributionRealForCheck) {
                    firstGrowthExceedsContributionYear = currentYearAge;
                }
                
                // 2. Million Dollar Milestone (Using Real End Balance)
                if (endBalanceReal >= 1000000 && !firstMillionDollarYear) {
                    firstMillionDollarYear = currentYearAge;
                }
                
                // --- Calculate Nominal Values for Table Storage ---
                const contributionNominal = convertToNominal(actualContributionRealTotal, year, inflationRate); 
                
                const requiredPrincipalNominal = convertToNominal(requiredCoastPrincipalThisYearReal, year, inflationRate);
                const growthNominal = convertToNominal(growthReal, year, inflationRate);
                
                const endBalanceNominal = convertToNominal(endBalanceReal, year, inflationRate);
                
                // Calculate Nominal Starting Balance (inflated by year-1)
                const startingBalanceNominal = convertToNominal(startingBalanceReal, year - 1, inflationRate);


                // --- Store Projection Data (using TOTAL figures for the main table) ---
                projectionData.push({
                    year: year,
                    age: currentYearAge,
                    requiredPrincipalReal: requiredCoastPrincipalThisYearReal,
                    startingBalanceReal: startingBalanceReal,
                    growthReal: growthReal,
                    contributionReal: actualContributionRealTotal, // Use the real contribution amount (0 if coasting)
                    endBalanceReal: endBalanceReal,
                    
                    requiredPrincipalNominal: requiredPrincipalNominal,
                    startingBalanceNominal: startingBalanceNominal,
                    growthNominal: growthNominal,
                    contributionNominal: contributionNominal,
                    endBalanceNominal: endBalanceNominal,
                    
                    isFinalRow: currentYearAge === retirementAge,
                    isGrowthExceedsContributionYear: currentYearAge === firstGrowthExceedsContributionYear,
                    isMillionDollarYear: currentYearAge === firstMillionDollarYear,
                    rowClass: rowClass,
                    coastTag: coastTag
                });

                currentAge++;
            }

            // --- Finalize Global Metrics ---
            // Final T/R balances at retirement age (from the last loop iteration)
            traditionalFinalBalanceRealGlobal = currentTraditionalBalanceReal;
            rothFinalBalanceRealGlobal = currentRothBalanceReal;
            
            projectedFinalValueReal = traditionalFinalBalanceRealGlobal + rothFinalBalanceRealGlobal;
            
            isCoastReachedGlobal = isCoastReachedLocal;
            
            if (isCoastReachedLocal) {
                yearsToCoastGlobal = yearsToCoastLocal === 0 ? '0 years' : `${yearsToCoastLocal.toFixed(0)} years`;
                yearsToCoastNumberGlobal = yearsToCoastLocal;
            } else {
                yearsToCoastGlobal = 'N/A';
                yearsToCoastNumberGlobal = Infinity;
            }
            
            coastAgeGlobal = coastAgeLocal;
            finalCoastValueReal = finalCoastValueLocal; // The required principal used for the milestone

            totalContributionsAtCoastRealGlobal = totalContributionsReal; 
            totalContributionsNominalGlobal = totalContributionsNominal; 
            
            // Call the function to render the UI with the default mode
            updateDisplay();
        }

        /**
         * Generates and updates the suggestions section. (Uses total values)
         */
        function updateSuggestions(currentContributions) {
            
            if (!isCoastReachedGlobal || yearsToCoastNumberGlobal === Infinity || yearsToCoastNumberGlobal === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            suggestionsContainer.classList.remove('hidden');
            
            const originalTotalContributions = totalContributionsAtCoastRealGlobal; 
            const currentYears = yearsToCoastNumberGlobal;
            const retireAge = retirementAgeGlobal;
            const currentAge = ageGlobal;
            
            // --- Scenario 1: Modest Increase (+ $100/month) ---
            const additional1200 = 1200;
            const newContrib1 = currentContributions + additional1200;
            
            const result1 = simulateToCoast(initialBalanceGlobal, currentAge, retireAge, realRateGlobal, fiTargetReal, newContrib1);
            const newYears1 = result1.years;
            const newTotalContributions1 = result1.contributions;
            
            let timeSaved1 = currentYears - newYears1;
            timeSaved1 = timeSaved1 > 0 ? timeSaved1 : 0; 
            
            // Calculate contribution savings
            const contributionSavings1 = originalTotalContributions - newTotalContributions1;
            const isSavings1 = contributionSavings1 >= 0;
            const savingsClass1 = isSavings1 ? 'text-green-600' : 'text-red-600';
            const savingsLabel1 = isSavings1 ? 'Total cash contributions saved' : 'Total additional cash contributions';

            if (newYears1 < currentYears) {
                suggestion1El.innerHTML = `
                    <p class="font-bold text-gray-800">Scenario 1: Increase contributions by ${formatCurrency(additional1200)}/year</p>
                    <p class="mt-1 text-gray-700">
                        Total annual contribution: <span class="font-semibold text-primary">${formatCurrency(newContrib1)}</span> (Today's $)
                    </p>
                    <p class="text-gray-700">
                        New time to Coast FI: <span class="font-semibold text-primary">${newYears1.toFixed(0)} years</span>
                    </p>
                    <p class="text-sm font-semibold text-green-600">
                        You'd shave off approximately <span class="font-extrabold">${timeSaved1.toFixed(1)} years!</span>
                    </p>
                    <p class="text-sm font-semibold ${savingsClass1} border-t pt-2 mt-2">
                        ${savingsLabel1} (in today's $): <span class="font-extrabold">${formatCurrency(Math.abs(contributionSavings1))}</span>
                    </p>
                `;
            } else {
                 suggestion1El.innerHTML = `
                    <p class="font-bold text-gray-800">Scenario 1: Increase contributions by ${formatCurrency(additional1200)}/year</p>
                    <p class="mt-1 text-gray-600">This increase is insufficient to accelerate your timeline significantly.</p>
                 `;
            }


            // --- Scenario 2: Significant Increase (50% boost) ---
            const currentContributionsAmount = parseFloat(document.getElementById('traditionalContributions').value) + parseFloat(document.getElementById('rothContributions').value);
            const boostPercentage = 0.5;
            const boostAmount = currentContributionsAmount * boostPercentage;
            const newContrib2 = currentContributionsAmount + boostAmount;

            const result2 = simulateToCoast(initialBalanceGlobal, currentAge, retireAge, realRateGlobal, fiTargetReal, newContrib2);
            const newYears2 = result2.years;
            const newTotalContributions2 = result2.contributions;
            
            let timeSaved2 = currentYears - newYears2;
            timeSaved2 = timeSaved2 > 0 ? timeSaved2 : 0; 
            
            // Calculate contribution savings
            const contributionSavings2 = originalTotalContributions - newTotalContributions2;
            const isSavings2 = contributionSavings2 >= 0;
            const savingsClass2 = isSavings2 ? 'text-green-600' : 'text-red-600';
            const savingsLabel2 = isSavings2 ? 'Total cash contributions saved' : 'Total additional cash contributions';

            if (newYears2 < currentYears) {
                suggestion2El.innerHTML = `
                    <p class="font-bold text-gray-800">Scenario 2: Boost contributions by ${boostPercentage * 100}%</p>
                    <p class="mt-1 text-gray-700">
                        Total annual contribution: <span class="font-semibold text-primary">${formatCurrency(newContrib2)}</span> (Today's $)
                    </p>
                    <p class="text-gray-700">
                        New time to Coast FI: <span class="font-semibold text-primary">${newYears2.toFixed(0)} years</span>
                    </p>
                    <p class="text-sm font-semibold text-green-600">
                        You'd shave off approximately <span class="font-extrabold">${timeSaved2.toFixed(1)} years!</span>
                    </p>
                    <p class="text-sm font-semibold ${savingsClass2} border-t pt-2 mt-2">
                        ${savingsLabel2} (in today's $): <span class="font-extrabold">${formatCurrency(Math.abs(contributionSavings2))}</span>
                    </p>
                `;
            } else {
                 suggestion2El.innerHTML = `
                    <p class="font-bold text-gray-800">Scenario 2: Boost contributions by ${formatCurrency(boostAmount)}/year</p>
                    <p class="mt-1 text-gray-600">This increase is insufficient to accelerate your timeline significantly.</p>
                 `;
            }
        }

        /**
         * Renders the UI (Key Milestones and Table) based on the current displayMode.
         * @param {boolean} isInitialRender - True if called due to invalid input/initial load.
         */
        function updateDisplay(isInitialRender = false) {
            
            if (isInitialRender || fiTargetReal === 0 || projectionData.length === 0) {
                 // Reset fields to 'N/A' or '0' when in an invalid state or no data
                 targetFIEl.textContent = '$0';
                 requiredCoastPrincipalEl.textContent = '$0';
                 yearsToCoastEl.textContent = 'N/A';
                 valueAtCoast.textContent = '$0';
                 totalContributionsEl.textContent = '$0';
                 coastAgeDisplayEl.textContent = 'N/A';
                 traditionalCoastBalanceEl.textContent = '$0';
                 rothCoastBalanceEl.textContent = '$0';
                 traditionalFinalBalanceEl.textContent = '$0';
                 rothFinalBalanceEl.textContent = '$0';
                 projectedFinalValueEl.textContent = '$0';
                 yearsToRetirementEl.textContent = '0';
                 realRateEl.textContent = '0%';
                 rateDisplayEl.innerHTML = `Real Rate of Return: <span id="realRate" class="font-bold text-secondary">0%</span>`;
                 
                 suggestionsContainer.classList.add('hidden');
                 recommendedActionsEl.classList.add('hidden'); // Hide actions on initial/invalid render
                 projectionContainer.innerHTML = '';
                 
                 // Prevent further display logic until valid input is received
                 return;
            }
            
            // Aggregate the total annual contributions from the two input fields
            const currentContributions = (parseFloat(document.getElementById('traditionalContributions').value) || 0) + (parseFloat(document.getElementById('rothContributions').value) || 0);
            
            // 1. Update Suggestions (for successful coasting)
            updateSuggestions(currentContributions);


            const valueKeySuffix = displayMode === 'nominal' ? 'Nominal' : 'Real';
            
            // Re-calculate rates for display
            const nominalRate = (parseFloat(document.getElementById('annualReturn').value) || 0) / 100;
            const yearsToRetirementValue = retirementAgeGlobal - ageGlobal;
            
            // 2. Context and Rate Label
            valueContextEl.innerHTML = displayMode === 'real' 
                ? 'All projected values are shown in **today\'s purchasing power (Real)**.'
                : 'All projected values are shown in **future dollars (Nominal)**.';
                
            // 3. Years to Retirement
            yearsToRetirementEl.textContent = yearsToRetirementValue > 0 ? yearsToRetirementValue.toFixed(0) : '0';
            retirementAgeDisplayEl.textContent = retirementAgeGlobal.toFixed(0);

            // 4. Rate of Return
            // Update Rate Label text
            rateDisplayEl.innerHTML = displayMode === 'nominal' 
                ? `Nominal Rate: <span id="realRate" class="font-bold text-secondary">${(nominalRate * 100).toFixed(2)}%</span>`
                : `Real Rate of Return: <span id="realRate" class="font-bold text-secondary">${(realRateGlobal * 100).toFixed(2)}%</span>`;


            // 5. FI Target
            const fiTargetValue = displayMode === 'nominal' 
                ? convertToNominal(fiTargetReal, yearsToRetirementValue, inflationRateGlobal)
                : fiTargetReal;
            targetFIEl.textContent = formatCurrency(fiTargetValue);

            // 6. Required Principal TODAY
            const requiredCoastPrincipalValue = displayMode === 'nominal' 
                ? convertToNominal(requiredCoastPrincipalTodayReal, 0, inflationRateGlobal) // Inflating by 0 years = today's nominal value
                : requiredCoastPrincipalTodayReal;
            requiredCoastPrincipalEl.textContent = formatCurrency(requiredCoastPrincipalValue);

            // 7. Years to Coast
            yearsToCoastEl.textContent = yearsToCoastGlobal;

            // 8. Required Value at Coast Date (Total)
            let requiredValueAtCoastDate = 0;
            if (isCoastReachedGlobal && yearsToCoastGlobal !== 'N/A') {
                const yearsToCoastNumber = parseFloat(yearsToCoastGlobal.split(' ')[0]);
                requiredValueAtCoastDate = displayMode === 'nominal'
                    ? convertToNominal(finalCoastValueReal, yearsToCoastNumber, inflationRateGlobal)
                    : finalCoastValueReal;
            }
            valueAtCoast.textContent = formatCurrency(requiredValueAtCoastDate);
            
            // 9. Total Contributions at Coast
            let totalContributionsValue = 0;
            if (isCoastReachedGlobal && yearsToCoastGlobal !== 'N/A') {
                if (displayMode === 'nominal') {
                    // Use the correctly accumulated Nominal Contributions (sum of inflated cash payments)
                    totalContributionsValue = totalContributionsNominalGlobal;
                } else {
                    // Total contributions in today's purchasing power (Real)
                    totalContributionsValue = totalContributionsAtCoastRealGlobal;
                }
            }
            totalContributionsEl.textContent = formatCurrency(totalContributionsValue);

            // --- 10. Coast Account Balances ---
            if (isCoastReachedGlobal && yearsToCoastGlobal !== 'N/A') {
                const yearsToCoastNumber = parseFloat(yearsToCoastGlobal.split(' ')[0]);
                
                coastAgeDisplayEl.textContent = coastAgeGlobal.toFixed(0);

                const tradCoastValue = displayMode === 'nominal' 
                    ? convertToNominal(traditionalCoastBalanceRealGlobal, yearsToCoastNumber, inflationRateGlobal)
                    : traditionalCoastBalanceRealGlobal;
                
                const rothCoastValue = displayMode === 'nominal'
                    ? convertToNominal(rothCoastBalanceRealGlobal, yearsToCoastNumber, inflationRateGlobal)
                    : rothCoastBalanceRealGlobal;

                traditionalCoastBalanceEl.textContent = formatCurrency(tradCoastValue);
                rothCoastBalanceEl.textContent = formatCurrency(rothCoastValue);
            } else {
                coastAgeDisplayEl.textContent = 'N/A';
                traditionalCoastBalanceEl.textContent = '$0';
                rothCoastBalanceEl.textContent = '$0';
            }


            // --- 11. Final Retirement Account Balances ---
            const yearsToFinal = retirementAgeGlobal - ageGlobal;
            
            const tradFinalValue = displayMode === 'nominal' 
                ? convertToNominal(traditionalFinalBalanceRealGlobal, yearsToFinal, inflationRateGlobal)
                : traditionalFinalBalanceRealGlobal;

            const rothFinalValue = displayMode === 'nominal' 
                ? convertToNominal(rothFinalBalanceRealGlobal, yearsToFinal, inflationRateGlobal)
                : rothFinalBalanceRealGlobal;

            traditionalFinalBalanceEl.textContent = formatCurrency(tradFinalValue);
            rothFinalBalanceEl.textContent = formatCurrency(rothFinalValue);


            // 12. Projected Final Value (Total)
            const projectedFinalValue = tradFinalValue + rothFinalValue; // Sum the T/R nominal/real values
            projectedFinalValueEl.textContent = formatCurrency(projectedFinalValue);
            
            // --- Verdict Logic (Uses REAL for comparison) ---
            // FIX: Removed the loose tolerance check (e.g., * 0.999) and replaced with a tight epsilon
            // to ensure a strict comparison while accounting for minor floating-point errors.
            const fiTargetIsMet = projectedFinalValueReal >= fiTargetReal - 0.0001; 

            if (fiTargetIsMet) {
                // SUCCESS STATE
                if (yearsToCoastNumberGlobal === 0) {
                    verdictEl.className = 'mt-4 p-4 rounded-lg text-white font-bold text-lg text-center bg-primary transition-all duration-300';
                    verdictEl.innerHTML = `🎉 **COAST FI ACHIEVED!** You are already coasting at Age **${ageGlobal.toFixed(0)}**.`;
                    yearsToCoastEl.textContent = '0 years (Age ' + ageGlobal.toFixed(0) + ')';
                } else {
                    verdictEl.className = 'mt-4 p-4 rounded-lg text-white font-bold text-lg text-center bg-yellow-600 transition-all duration-300';
                    verdictEl.innerHTML = `⏳ **SPRINT SUCCESSFUL:** Coast FI reached in **${yearsToCoastGlobal}** at age **${coastAgeGlobal.toFixed(0)}**.`;
                    yearsToCoastEl.textContent = `${yearsToCoastGlobal} (Age ${coastAgeGlobal.toFixed(0)})`;
                }
                projectedFinalValueEl.classList.remove('text-red-500');
                projectedFinalValueEl.classList.add('text-primary');
                recommendedActionsEl.classList.add('hidden'); // Hide actions on success
            } else {
                // FAILURE STATE
                verdictEl.className = 'mt-4 p-4 rounded-lg text-white font-bold text-lg text-center bg-red-500 transition-all duration-300';
                
                if (yearsToRetirementValue === 0) {
                    verdictEl.innerHTML = `❌ **FI TARGET MISSED!** Not enough funds by Age ${retirementAgeGlobal}. Increase balance or lower target.`;
                } else {
                    verdictEl.innerHTML = `❌ **FI TARGET MISSED!** Coast FI was not met by Age ${retirementAgeGlobal}. Increase contributions or lower your target.`;
                }
                
                // FIX: Ensure years to coast is N/A on failure, as the goal was not strictly met.
                yearsToCoastEl.textContent = `N/A`;
                
                projectedFinalValueEl.classList.remove('text-primary');
                projectedFinalValueEl.classList.add('text-red-500');
                
                // Show and populate recommended actions
                recommendedActionsEl.classList.remove('hidden');
                updateRecommendedActions();
            }

            // --- Render Projection Table ---
            const principalHeader = displayMode === 'nominal' ? 'Req. Principal (Future $)' : 'Req. Principal (Today\'s $)';
            const startingBalanceHeader = 'Start Balance (Total)'; 
            
            let projectionHTML = `
                <h3 class="text-lg font-semibold text-secondary mt-6 mb-3 border-b pb-1 text-center">Full FI Roadmap (Values in ${valueKeySuffix} Dollars)</h3>
                <div class="projection-table-wrapper rounded-lg border border-gray-200">
                    <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Year #</th>
                                <th class="p-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Age</th>
                                <th class="p-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">${principalHeader}</th>
                                <th class="p-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">${startingBalanceHeader}</th>
                                <th class="p-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Growth</th>
                                <th class="p-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Contribution</th>
                                <th class="p-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">End Balance (Total)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            projectionData.forEach(data => {
                const requiredPrincipal = data[`requiredPrincipal${valueKeySuffix}`];
                const startingBalance = data[`startingBalance${valueKeySuffix}`];
                const growth = data[`growth${valueKeySuffix}`];
                const contribution = data[`contribution${valueKeySuffix}`]; 
                const endBalance = data[`endBalance${valueKeySuffix}`];
                
                let highlightClass = data.rowClass;
                let milestoneTag = data.coastTag;
                
                // Prioritize Coast FI and Final Row, otherwise apply milestone highlights
                if (data.isFinalRow) {
                    highlightClass = 'final-row';
                } else if (data.rowClass === 'sprint-end-row') {
                    // COAST FI Milestone is second priority
                    highlightClass = 'sprint-end-row';
                } else {
                    // Crossover/Million are the lowest priority highlights, apply only if not already coastal/final
                    if (data.isGrowthExceedsContributionYear) {
                         highlightClass = 'growth-cross-row';
                         milestoneTag = milestoneTag || '🌟 Crossover Point';
                    }
                    if (data.isMillionDollarYear) {
                        // Million Dollar is also a huge milestone, let's make it visible
                        highlightClass = 'million-dollar-row';
                        milestoneTag = milestoneTag || '💰 $1M Real Balance';
                    }
                }

                projectionHTML += `
                    <tr class="${highlightClass}">
                        <td class="p-3 whitespace-nowrap">${data.year}</td>
                        <td class="p-3 whitespace-nowrap">${data.age.toFixed(0)}</td>
                        <td class="p-3 whitespace-nowrap text-right text-accent-blue">${formatCurrency(requiredPrincipal)}</td>
                        <td class="p-3 whitespace-nowrap text-right">${formatCurrency(startingBalance)}</td>
                        <td class="p-3 whitespace-nowrap text-right">${formatCurrency(growth)}</td>
                        <td class="p-3 whitespace-nowrap text-right">${formatCurrency(contribution)}</td>
                        <td class="p-3 whitespace-nowrap text-right">${formatCurrency(endBalance)} ${milestoneTag}</td>
                    </tr>
                `;
            });

            projectionHTML += `
                        </tbody>
                    </table>
                    </div>
                </div>
            `;
            
            projectionContainer.innerHTML = projectionHTML;
            
            // --- Update Button Styles ---
            if (displayMode === 'real') {
                realModeBtn.classList.add('bg-primary', 'text-white');
                realModeBtn.classList.remove('bg-gray-300', 'text-gray-700');
                nominalModeBtn.classList.add('bg-gray-300', 'text-gray-700');
                nominalModeBtn.classList.remove('bg-primary', 'text-white');
            } else {
                nominalModeBtn.classList.add('bg-primary', 'text-white');
                nominalModeBtn.classList.remove('bg-gray-300', 'text-gray-700');
                realModeBtn.classList.add('bg-gray-300', 'text-gray-700');
                realModeBtn.classList.remove('bg-primary', 'text-white');
            }
        }

        /**
         * Calculates and populates the recommended actions section on failure.
         */
        function updateRecommendedActions() {
            const shortfall = fiTargetReal - projectedFinalValueReal;
            
            if (shortfall <= 0 || fiTargetReal === 0) return; // Should only run on failure

            // Update the shortfall message
            shortfallMessageEl.innerHTML = 
                `Your projected final value is **${formatCurrency(shortfall)}** short of your required FI Target of **${formatCurrency(fiTargetReal)}** (in today's dollars).`;

            const yearsToRetirementValue = retirementAgeGlobal - ageGlobal;
            const realRate = realRateGlobal;
            
            // --- ACTION 1: Increase Annual Contribution (in real dollars) ---
            if (yearsToRetirementValue > 0 && realRate > 0) {
                // Future Value of Annuity Factor: FVAF = ((1 + r)^n - 1) / r
                const fvaf = (Math.pow(1 + realRate, yearsToRetirementValue) - 1) / realRate;
                
                // Additional Real Annual Contribution needed (C = FV / FVAF)
                const additionalContributionReal = shortfall / fvaf;
                
                // Store globally for button action
                suggestedAdditionalContributionReal = additionalContributionReal;

                action1El.innerHTML = `
                    <p class="font-bold text-gray-800">Option 1: Increase Your Annual Savings</p>
                    <p class="mt-1 text-gray-700">To hit your target at age ${retirementAgeGlobal}, you must increase your **annual real contribution** by:</p>
                    <p class="text-xl font-extrabold text-red-600 mt-2">${formatCurrency(additionalContributionReal)}</p>
                    <p class="text-xs text-gray-500 mt-1">This is the additional amount you need to save *every year* from now on (in today's purchasing power).</p>
                    <div class="mt-3 text-center">
                        <button id="applyAction1" class="apply-action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            Apply New Contribution
                        </button>
                    </div>
                `;
                 document.getElementById('applyAction1')?.addEventListener('click', handleApplyAction1);
            } else {
                 action1El.innerHTML = `
                    <p class="font-bold text-gray-800">Option 1: Increase Your Annual Savings</p>
                    <p class="mt-1 text-gray-600">Cannot calculate required annual savings: Real rate is zero or years to retirement is zero.</p>
                `;
            }

            // --- ACTION 2: Delay Retirement Age (passive growth) ---
            if (realRate > 0 && projectedFinalValueReal > 0) {
                // Required Years to Grow: x = ln(F/A) / ln(1+r)
                const requiredGrowthRatio = fiTargetReal / projectedFinalValueReal;
                const extraYearsFloat = Math.log(requiredGrowthRatio) / Math.log(1 + realRate);
                const newRetirementAge = retirementAgeGlobal + extraYearsFloat;
                
                // Store globally for button action (use ceiling for practical age)
                suggestedNewRetirementAge = newRetirementAge;

                action2El.innerHTML = `
                    <p class="font-bold text-gray-800">Option 2: Delay Retirement Age</p>
                    <p class="mt-1 text-gray-700">If you stop contributing today, your current balance will reach the full target at approximately:</p>
                    <p class="text-xl font-extrabold text-red-600 mt-2">Age ${newRetirementAge.toFixed(1)}</p>
                    <p class="text-xs text-gray-500 mt-1">This means you need to delay retirement by **${extraYearsFloat.toFixed(1)} years** without further contributions.</p>
                    <div class="mt-3 text-center">
                        <button id="applyAction2" class="apply-action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            Apply New Retirement Age
                        </button>
                    </div>
                `;
                document.getElementById('applyAction2')?.addEventListener('click', handleApplyAction2);
            } else {
                 action2El.innerHTML = `
                    <p class="font-bold text-gray-800">Option 2: Delay Retirement Age</p>
                    <p class="mt-1 text-gray-600">Cannot calculate required delay: Real rate is zero or projected final value is zero.</p>
                `;
            }

        }
        
        // --- Action Handlers ---

        function handleApplyAction1(e) {
            e.preventDefault();
            
            if (suggestedAdditionalContributionReal <= 0) return;

            const additionalContributionReal = suggestedAdditionalContributionReal;

            const traditionalContributionsInput = document.getElementById('traditionalContributions');
            const rothContributionsInput = document.getElementById('rothContributions');

            const currentTraditional = parseFloat(traditionalContributionsInput.value) || 0;
            const currentRoth = parseFloat(rothContributionsInput.value) || 0;
            const totalCurrent = currentTraditional + currentRoth;

            let newTraditional = 0;
            let newRoth = 0;

            // Calculate the new total contribution required (Current Total + Additional)
            const newTotalContribution = totalCurrent + additionalContributionReal;

            // Distribute the new total contribution based on the original ratio
            if (totalCurrent > 0) {
                const traditionalRatio = currentTraditional / totalCurrent;
                newTraditional = newTotalContribution * traditionalRatio;
                newRoth = newTotalContribution * (1 - traditionalRatio);
            } else {
                // If current contribution is 0, put all additional into Traditional
                newTraditional = newTotalContribution;
                newRoth = 0;
            }
            
            // Update the inputs, rounding to whole numbers for user display
            traditionalContributionsInput.value = Math.round(newTraditional).toFixed(0);
            rothContributionsInput.value = Math.round(newRoth).toFixed(0);

            // Recalculate everything
            calculateCoastFI();
        }

        function handleApplyAction2(e) {
            e.preventDefault();
            
            if (suggestedNewRetirementAge <= retirementAgeGlobal) return;

            // Use the ceiling of the suggested age
            const newRetirementAge = Math.ceil(suggestedNewRetirementAge); 
            
            // Update the Retirement Age input
            const retirementAgeInput = document.getElementById('retirementAge');
            retirementAgeInput.value = newRetirementAge.toFixed(0);

            // Recalculate everything
            calculateCoastFI();
        }


        // --- Math Evaluation ---
        function evaluateMathExpression(expression) {
            try {
                // Allow numbers, arithmetic operators, parentheses, and decimals.
                if (/^[\d\s\+\-\*\/\(\)\.]+$/.test(expression)) {
                    const result = new Function('return ' + expression)();
                    if (typeof result === 'number' && isFinite(result)) {
                        return result;
                    }
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function setupContributionInput(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('blur', () => {
                    const expression = input.value;
                    if (expression.match(/[\+\-\*\/]/)) { // Only evaluate if it contains an operator
                        const result = evaluateMathExpression(expression);
                        if (result !== null) {
                            input.value = result.toFixed(0);
                            // Manually trigger the input event to recalculate the FI details
                            input.dispatchEvent(new Event('input'));
                        }
                    }
                });
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = form.querySelectorAll('input');

            // Load saved data from localStorage and add event listeners
            inputs.forEach(input => {
                const savedValue = localStorage.getItem(input.id);
                if (savedValue !== null) {
                    input.value = savedValue;
                }

                input.addEventListener('input', () => {
                    localStorage.setItem(input.id, input.value);
                    calculateCoastFI();
                });
            });

            setupContributionInput('traditionalContributions');
            setupContributionInput('rothContributions');
            
            realModeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                displayMode = 'real';
                updateDisplay();
            });

            nominalModeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                displayMode = 'nominal';
                updateDisplay();
            });

            // Run on load with default values
            calculateCoastFI();
        });

    </script>
</body>
</html>
